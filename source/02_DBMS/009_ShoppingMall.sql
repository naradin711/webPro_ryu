-- [IX] 쇼핑몰 설계

--1. 요구사항을 보고 테이블 설계
--1-1. 해당 EXR을 엑셀에 넣어보기
--2. SQL문 (테이블생성, 시퀀스생성, 데이터 INSERT)

--MEMBER - mID, mNAME, mADDR, mTEL
--PRODUCT - pCODE, pNAME, PRICE, pSTOCK
--CART - SEQ, mID, pCODE1, QTY1, COST1
--ORDERS - oNO(PK), mID, oADDR, oTEL, oDATE
--ORDER_DETAIL - oNO, pCODE, QTY, COST (수량*단가)

DROP TABLE MEMBER; -- 테이블 초기화
CREATE TABLE MEMBER(
       mID VARCHAR2(100) PRIMARY KEY,
       mNAME VARCHAR2(100),
       mADDR VARCHAR2(100) UNIQUE,
       mTEL VARCHAR2(100) UNIQUE
       );
INSERT INTO MEMBER VALUES ('ABC', '홍길동', '서울 강남구', '010-1111-1111');       
INSERT INTO MEMBER VALUES ('DEF', '전투왕', '서울 서대문구', '010-2222-2222'); 

SELECT * FROM MEMBER; -- 입력값 확인

COMMIT;

DROP TABLE PRODUCT; -- 테이블 초기화
CREATE TABLE PRODUCT(
       pCODE  VARCHAR2(100) PRIMARY KEY,
       pNAME  VARCHAR2(100) UNIQUE,
       PRICE  NUMBER(20)    CHECK(PRICE>0),
       pSTOCK NUMBER(20)    CHECK(pSTOCK>=0) 
       );
INSERT INTO PRODUCT VALUES ('A1', '맥주', 3000, 50);
INSERT INTO PRODUCT VALUES ('A2', '소주', 2000, 75);
INSERT INTO PRODUCT VALUES ('B1', '땅콩', 3500, 68);
INSERT INTO PRODUCT VALUES ('B2', '오징어', 5000, 42);
INSERT INTO PRODUCT VALUES ('C1', '기저귀', 7000, 20);

SELECT * FROM PRODUCT; -- 입력값 확인

COMMIT;

DROP TABLE ORDERS; -- 테이블 초기화
DROP SEQUENCE ORDER_SEQ; -- 시퀀스 초기화
CREATE SEQUENCE ORDER_SEQ -- 시퀀스 만들기
       MAXVALUE 9999     -- 최대값
       MINVALUE 1        -- 최소값
       NOCACHE           -- 새로운 시퀀스를 시작할때 캐시 메모리를 초기화 하는 행.
       NOCYCLE   ;
       
CREATE TABLE ORDERS (
       oNO   VARCHAR2(100) PRIMARY KEY,
       oADDR VARCHAR2(100) UNIQUE,
       oTEL  VARCHAR2(100) UNIQUE,
       oDATE DATE          DEFAULT SYSDATE
       );
INSERT INTO ORDERS (oNO, oADDR, oTEL)
    VALUES (TO_CHAR(SYSDATE,'YYYYMMDD') || TRIM(TO_CHAR(ORDER_SEQ.NEXTVAL, '00000')), '서울 강남구', '010-1111-1111' ) ; 
INSERT INTO ORDERS (oNO, oADDR, oTEL)
    VALUES (TO_CHAR(SYSDATE,'YYYYMMDD') || TRIM(TO_CHAR(ORDER_SEQ.NEXTVAL, '00000')), '서울 서대문구 ', '010-2222-2222' ) ;
INSERT INTO ORDERS (oNO, oADDR, oTEL)
    VALUES (TO_CHAR(SYSDATE,'YYYYMMDD') || TRIM(TO_CHAR(ORDER_SEQ.NEXTVAL, '00000')), '경기도 과천', '010-3333-3333' ) ;

SELECT * FROM ORDERS;

COMMIT;

DROP TABLE ORDER_DETAIL; -- 테이블 초기화
DROP SEQUENCE OD_SEQ; -- 시퀀스 초기화
CREATE SEQUENCE OD_SEQ -- 시퀀스 만들기
       MAXVALUE 9999     -- 최대값
       MINVALUE 1        -- 최소값
       NOCACHE           -- 새로운 시퀀스를 시작할때 캐시 메모리를 초기화 하는 행.
       NOCYCLE   ;
CREATE TABLE ORDER_DETAIL ( -- ORDER_DETAIL 할때 하나씩 팔 때마다 PRODUCT에 수량 변화 UPDATE시키기
       odNO   NUMBER(20)    PRIMARY KEY,
       oNO    VARCHAR2(100) REFERENCES ORDERS (oNO),
       pCODE  VARCHAR2(100) REFERENCES PRODUCT (pCODE),
       QTY NUMBER(20) CHECK (QTY>0),
       COST NUMBER(20) CHECK (COST>0)
       );
INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-1111-1111'), 
       'A1', 3, 3*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A1'));
UPDATE PRODUCT SET pSTOCK = pSTOCK - 3 WHERE pCODE = 'A1';       
INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-1111-1111'), 
       'A1', 1, (SELECT PRICE FROM PRODUCT WHERE PCODE = 'B1')); 
UPDATE PRODUCT SET pSTOCK = pSTOCK - 1 WHERE pCODE = 'B1'; 

INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-1111-1111'), 
       'A2', 2, 2*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A2'));
 UPDATE PRODUCT SET pSTOCK = pSTOCK - 2 WHERE pCODE = 'A2';  
 
INSERT INTO ORDER_DETAIL
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-1111-1111'), 
       'B2', 1, (SELECT PRICE FROM PRODUCT WHERE PCODE = 'B2'));
UPDATE PRODUCT SET pSTOCK = pSTOCK - 1 WHERE pCODE = 'B2';

INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-2222-2222'), 
       'A2', 2, 2*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A2'));
INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-2222-2222'), 
       'B2', 1, (SELECT PRICE FROM PRODUCT WHERE PCODE = 'B2'));
INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-2222-2222'), 
       'C1', 1, (SELECT PRICE FROM PRODUCT WHERE PCODE = 'C1'));
INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-3333-3333'), 
       'A1', 2, 2*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A1')); 
INSERT INTO ORDER_DETAIL
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-3333-3333'), 
       'B1', 1, (SELECT PRICE FROM PRODUCT WHERE PCODE = 'B1'));
INSERT INTO ORDER_DETAIL 
       VALUES (OD_SEQ.NEXTVAL, (SELECT oNO FROM ORDERS WHERE oTEL ='010-3333-3333'), 
       'C1', 1, (SELECT PRICE FROM PRODUCT WHERE PCODE = 'C1'));       
       
SELECT * FROM ORDER_DETAIL; -- 입력값 확인

SELECT SUM(QTY) FROM ORDER_DETAIL WHERE pCODE = 'A1';

COMMIT;   
       

DROP TABLE CART; -- 테이블 초기화
DROP SEQUENCE CART_SEQ; -- 시퀀스 초기화
CREATE SEQUENCE CART_SEQ -- 시퀀스 만들기
       MAXVALUE 9999     -- 최대값
       MINVALUE 1        -- 최소값
       NOCACHE           -- 새로운 시퀀스를 시작할때 캐시 메모리를 초기화 하는 행.
       NOCYCLE   ;
CREATE TABLE CART (
       cNO   NUMBER(20)    PRIMARY KEY,
       mID    VARCHAR2(100) REFERENCES MEMBER (mID),
       pCODE  VARCHAR2(100) REFERENCES PRODUCT (pCODE),
       QTY    NUMBER(20)    CHECK (QTY>0),
       COST   NUMBER(20)    CHECK (COST>0)
       );
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 
            (SELECT mID FROM MEMBER WHERE mID = 'ABC'),
            (SELECT pCODE FROM PRODUCT WHERE pCODE = 'A1'),
            3, 3*(SELECT PRICE FROM PRODUCT WHERE PCODE = 'A1'));  

SELECT * FROM CART; -- 입력값 확인

COMMIT;  


-- UPDATE를 이용하여 재고값 갱신하기

UPDATE PRODUCT SET pSTOCK = (SELECT  pSTOCK - (SELECT SUM(QTY) FROM ORDER_DETAIL OD WHERE pCODE = 'A1')
                             FROM PRODUCT WHERE pCODE = 'A1') WHERE pCODE = 'A1';
UPDATE PRODUCT SET pSTOCK = (SELECT  pSTOCK - (SELECT SUM(QTY) FROM ORDER_DETAIL OD WHERE pCODE = 'A2')
                             FROM PRODUCT WHERE pCODE = 'A2') WHERE pCODE = 'A2';
UPDATE PRODUCT SET pSTOCK = (SELECT  pSTOCK - (SELECT SUM(QTY) FROM ORDER_DETAIL OD WHERE pCODE = 'B1')
                             FROM PRODUCT WHERE pCODE = 'B1') WHERE pCODE = 'B1';
UPDATE PRODUCT SET pSTOCK = (SELECT  pSTOCK - (SELECT SUM(QTY) FROM ORDER_DETAIL OD WHERE pCODE = 'B2')
                             FROM PRODUCT WHERE pCODE = 'B2') WHERE pCODE = 'B2';
UPDATE PRODUCT SET pSTOCK = (SELECT  pSTOCK - (SELECT SUM(QTY) FROM ORDER_DETAIL OD WHERE pCODE = 'C1')
                             FROM PRODUCT WHERE pCODE = 'C1') WHERE pCODE = 'C1';

SELECT * FROM PRODUCT;

COMMIT;




